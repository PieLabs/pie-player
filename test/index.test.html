<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../node_modules/web-component-tester/browser.js"></script>
  <script src="bundle.js"></script>
  <script type="text/javascript">

    class MyComp extends HTMLElement {

      connectedCallback() {
        this.dispatchEvent(new CustomEvent('pie.register', { bubbles: true }));
      }
    }

    customElements.define('my-comp', MyComp);

    class SimpleElement extends HTMLElement {

      constructor() {
        super();
      }

      set title(t) {

        console.log('>>>>> set title: ', t);
        this.innerHTML = t;
      }
    }

    customElements.define('simple-element', SimpleElement);

    document.addEventListener('pie.register', function (event) {
      console.log('got a pie.register', event)
    });

  </script>
</head>

<body>
  <pie-player>
    <my-comp pie-id="1"></my-comp>
    <simple-element data-id="2"></simple-element>
  </pie-player>
  <script>

    const colorMap = {
      black_on_rose: 'black-on-rose',
      white_on_black: 'white-on-black',
      black_on_white: 'default'
    };

    describe('<pie-player>', function () {
      var el, mockController;
      beforeEach(function (done) {

        var calledDone = false;
        mockController = {
          model: sinon.spy(function () {
            console.log('arguments: ' + JSON.stringify(arguments));
            return Promise.resolve([{ id: '1', value: 'model-result' }]);
          })
        };

        el = document.querySelector('pie-player');

        el.addEventListener('pie.model-updated', function (event) {
          console.log('model has been updated');
          if (!calledDone) {
            calledDone = true;
            done();
          }
        });

        el.env = { mode: 'gather' };
        el.session = [];
        el.controller = mockController;
        el.elementModels = [
          { element: 'simple-element', title: 'hi', id: '2' }
        ];
      });

      it('isnt null', () => {
        expect(el).not.to.be.null;
      });

      it('has 1 _pie at _pie[1]', () => {
        expect(el._pies['1']).not.to.be.null;
      });

      it('has _pie[1].model ', () => {
        expect(el._pies['1'].model).to.eql({ id: '1', value: 'model-result' });
      });

      it('has _pie[1].session ', () => {
        expect(el._pies['1'].session).to.eql({ id: '1' });
      });

      it('calls controller.model', () => {
        sinon.assert.calledWith(mockController.model, [{ id: '1' }], { mode: 'gather' });
      });

      it('sets the element env', (done) => {
        setTimeout(() => {
          expect(document.querySelector('simple-element').env.mode).to.eql('gather');
          done();
        }, 1000);
      });

      it('sets the element models', (done) => {
        setTimeout(() => {
          expect(document.querySelector('simple-element').innerHTML).to.eql('hi');
          done();
        }, 1000);
      });

      describe('changing env colorContrast', () => {

        Object.keys(colorMap).forEach((contrast) => {
          let cssClass = colorMap[contrast];

          describe(`to ${contrast}`, () => {

            it(`sets class on <pie-player> to ${cssClass}`, () => {
              el.env = {
                mode: 'gather',
                accessibility: {
                  colorContrast: contrast
                }
              };
              expect(el.getAttribute('class')).to.eql(cssClass);
            });

          });
          
        });
        
      });
    });
  </script>
</body>

</html>